# HuntingStuxbot
THM/HTB malware hunt

## Objective

Find and trace a R.A.T. in the system.

This is a text only write up of the successful steps taken to identify and get to the root of the infection.  Stuxbot is a R.A.T with multiple C&C servers.

### Skills Learned

- Threat-hunting fundamentals: hypothesis-driven search for anomalous activity (follow the evidence from email → file → process → network).
- Event/log triage: using Sysmon/Windows event streams to find suspicious behavior (process creation, file creation/streams).
- IOC discovery & enrichment: extracting file paths, hashes, DNS queries and destination IPs to create indicators of compromise.

### Tools Used

- Sysmon
- Windows Event Viewer/Event Logs
- Splunk
- KQL/SPL queries
- Process Explorer/Task Manager
- DNS/IP/IOC

## Notes

C&C Nodes:    91.90.213.14:443
              103.248.70.64:443
              141.98.6.59:443
```
event.code:15 AND file.name:*invoice.one      --> FileCreateStreamHash
--- March 26, 2023 @ 22:05;47
event.code:11 AND file.name:invoice.one*      --> FileCreate
```
Host name: WS001.eagle.local
IP Add:    192.168.28.130

```
event.code:1 AND process.parent.name:"ONENOTE.EXE"
```

### What is the parent process?
ONENOTE.EXE - invoice.one --> cmd.exe --> invoice.bat
                ^  executes   ^    ^ initiates ^

```
event.code:1 ANd process.parent.command_line:*invoice.bat*
```
This query has 1 result.  Powershell script was downloaded from pastebin.

### Trace what PS did:
- Use the PID #9944 to filter:
```
process.pid:"9944" and process.name:"powershell.exe"
```
Add fields: process.pid, event.code, file.path, dns.question.name, destination.ip
    - Password spraying script dumped on disk.
    - EXE file dropped on disk - matches the threat intel on persistence.
    - DNS for NGROK address and connections right after.
    - Created some cmd line files - likely part of initial stager right after downloads from pastebin.
```
            * dest.ip = 192.168.28.200
                        18.158.249.75     <=------ ZEEK!!!!
```
- Columns added:  source.ip, destination.ip, destination.port
      - Activity abruptly ends next day -> add dns.answers.data and search for *ngrok.io*
- New IP!!!   3.125.102.39
        ***EXAMINE DEFAULT.EXE***

  KQL = process.name:"default.exe"
  Add columns: process.name, process.args, event.code, file.path, destination.ip, dns.question.name

  - Various svchost.exe uploads ? - unknown?
  - Upload of Sharphound.exe - did it launch?!
  - Upload of payload.exe -> vbs file.

  KQL = process.name:"SharpHound.exe" <---- Tool for diagramming AD & path for escalation.

  - Executed twice in a couple of minutes.
  - Sysmon flagged "default.exe" with hash (process.hash.sha256) that matches on found in threat intel report.

### Use has for a bread search.  Has it been detected on other devices?
      * Add column: hot.hostname

  - KQL = process.hash.sha256:108d37cbd3878258c29db3bc293f2988b6ae688843801b9abc
  - Files with same has values detected on PKI server.
      - Used svc-sql1 account = compromised!
      - How was account compromise?!?
          - Preview PS script for brute forcing uploaded on WS0001
              *??  Check for successful or failed pw attempts from WS001*
```
KQL=(event.code:4624 OR event.code:4625) AND winlog.event_data.LogonType:3 AND source.ip:192.168.28.130
```
  - Two failed attempts for admin account
  - Multiple successful logon attempts for svc-sql1

####  What was the VBS file?
  XceGuhkzaTroy.vbs
#### What were the mimikatz args?
  lsadump::dcsync/domain:eagle.local /all /csv, exit

## *PS1 script generated by "PowerView"*
